---
title: "Introduction to splstyle"
author: "Richard White, Chi Zhang, Celine Victoria Berg-Hansen"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    fig_width: 6
    fig_height: 6
vignette: >
  %\VignetteIndexEntry{Introduction to splstyle}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Checklist

-   Make sure that your dataset contains all days/weeks (i.e. there can be days/weeks with 0 cases)
-   Use `q <- q + splstyle::theme_fhi_lines_horizontal()`
-   Use `q <- q + geom_col(fill = splstyle::base_color, width = 0.8)`
-   For `scale_y_continuous` use `breaks = splstyle::pretty_breaks(5)`
-   For `scale_y_continuous` use `expand = expansion(mult = c(0, 0.1))`
-   If the x-axis is too cramped, make the labels vertical `q <- q + splstyle::set_x_axis_vertical()`
-   Say when your data was extracted `q <- q + labs(caption = "Data extracted on 2018-02-20"` or\
    `q <- q + labs(caption = fhi_caption())`

If multiple geographical areas:\
- Use `q <- q + lemon::facet_rep_wrap(~location_code, repeat.tick.labels = "y")`

```{r}
library(ggplot2)
library(data.table)
library(spldata)
library(spltime)
library(splstyle)
```

## Data

We generally start with a linelist dataset (make sure it is a `data.table`!).

```{r}
set.seed(4)
dates <- sample(seq.Date(as.Date("2018-01-01"),
                         as.Date("2018-02-08"), 1),
                20000,
                replace = T)
d <- expand.grid(
  location_code = unique(
    spldata::norway_locations_names_b2020[granularity_geo == "county"]$location_code
    ),
  date = dates
)
# Convert to data.table
setDT(d)

# temporary solution
d[, n := stats::rpois(.N, 500)]

# print
print(d)
```

We now:

1.  Convert this into a `data.table` (in case it isn't already)
2.  Aggregate it to daily data (this dataset doesn't contain any days with 0 cases)
3.  Create a 'skeleton' dataset that contains all days from the first to last day
4.  Merge the two datasets together (so you now have a dataset that contains days with 0 cases)
5.  Fill in 'missing' N's with 0 (they are the dates that came from the skeleton dataset)

```{r}
# Convert to data.table
setDT(d)

# Aggregate
d <- d[,
  .(
    n = .N
  ),
  keyby = .(
    location_code,
    date
  )
]
# Aggregated daily dataset that does not contain days with 0 cases
print(d)

# create skeleton
skeleton <- data.table(expand.grid(
  location_code = unique(
    spldata::norway_locations_names_b2020[granularity_geo == "county"]$location_code
    ),
  date = seq.Date(min(d$date), max(d$date), 1)
))

# Merge the two datasets together
d <- merge(d, skeleton, by=c("location_code", "date"), all=T)

# Fill in 'missing' Ns with 0
d[is.na(n), n := 0]

# Include location_name in the dataset 
d[, location_name := splstyle::location_code_to_character(location_code)]

# Now you have a clean aggregated daily dataset that contains days with 0 cases!
print(d)
```

We can also create a weekly dataset:

```{r}
# create 3 new variables:
d[, isoyearweek := spltime::date_to_isoyearweek_c(date)]

# aggregate down to weekly level
w <- d[,
  .(
    n = sum(n)
  ),
  keyby = .(
    location_code,
    isoyearweek
  )
]

w[, location_name := splstyle::location_code_to_character(location_code)]

print(w)
```

## Graphs for one geographical area

Daily epicurve for `county03`

```{r}
q <- ggplot(d[location_code == "county03"], aes(x = date, y = n))
q <- q + geom_col(fill = splstyle::base_color, width = 0.8)
q <- q + scale_x_date("Date")
q <- q + scale_y_continuous(
  "Number of reported cases",
  breaks = splstyle::pretty_breaks(5),
  expand = expansion(mult = c(0, 0.1))
)
q <- q + labs(title = "Epicurve from 2018-01-01 to 2018-02-20")
q <- q + labs(caption = fhi_caption())
q <- q + splstyle::theme_fhi_lines_horizontal()
q
```

Weekly epicurve for `county03`

```{r}
q <- ggplot(w[location_code=="county03"], aes(x = isoyearweek, y = n))
q <- q + geom_col(fill = splstyle::base_color, width = 0.8)
q <- q + scale_x_discrete("Isoweek")
q <- q + scale_y_continuous("Number of reported cases",
  breaks = splstyle::pretty_breaks(5),
  expand = expansion(mult = c(0, 0.1))
)
q <- q + labs(title = "Epicurve from 2018-01-01 to 2018-02-20")
q <- q + labs(caption = fhi_caption())
q <- q + splstyle::theme_fhi_lines_horizontal()
q
```

Weekly epicurve with vertical x-axis labels

```{r}
q <- ggplot(w, aes(x = isoyearweek, y = n))
q <- q + geom_col(fill = splstyle::base_color, width = 0.8)
q <- q + scale_x_discrete("Isoweek")
q <- q + scale_y_continuous("Number of reported cases",
  breaks = splstyle::pretty_breaks(5),
  expand = expansion(mult = c(0, 0.1))
)
q <- q + labs(title = "Epicurve from 2018-01-01 to 2018-02-20")
q <- q + labs(caption = fhi_caption())
q <- q + splstyle::theme_fhi_lines_horizontal()
q <- q + splstyle::set_x_axis_vertical()
q
```

```{r}
q <- ggplot(d, aes(x = date, group = location_name))
q <- q + geom_line(lwd = 1,
                   mapping = aes(y = n), 
                   color = splstyle::base_color)
q <- q + lemon::facet_rep_wrap(~location_name, repeat.tick.labels = "y")
# q <- q + scale_x_discrete("Isoweek")
q <- q + scale_y_continuous("Number of reported cases",
  breaks = splstyle::pretty_breaks(5),
  expand = expansion(mult = c(0, 0.1))
  )
q <- q + labs(title = "Epicurve from 2018-01-01 to 2018-02-20")
q <- q + labs(caption = fhi_caption())
q <- q + splstyle::theme_fhi_lines_horizontal()
  
q <- q + splstyle::set_x_axis_vertical()
  
q
```

## Epicurves for multiple geographical areas

When we have multiple geographical areas, we use the function `lemon::facet_rep_wrap` to create multiple epicurves.

Daily epicurve for all geographical areas with vertical x-axis labels

```{r fig.height=10, fig.width=8}
q <- ggplot(d, aes(x = date, y = n))
q <- q + geom_col(fill = splstyle::base_color, width = 0.8)
q <- q + lemon::facet_rep_wrap(~location_name, repeat.tick.labels = "y")
q <- q + splstyle::scale_fill_fhi("Location",palette="primary")
q <- q + scale_x_date("Date")
q <- q + scale_y_continuous("Number of reported cases",
  breaks = splstyle::pretty_breaks(5),
  expand = expansion(mult = c(0, 0.1))
)
q <- q + labs(title = "Epicurve from 2018-01-01 to 2018-02-20")
q <- q + labs(caption = fhi_caption())
q <- q + splstyle::theme_fhi_lines_horizontal()
q <- q + splstyle::set_x_axis_vertical()
q
```

Weekly epicurve with vertical x-axis labels

```{r fig.height=10, fig.width=8}
q <- ggplot(d, aes(x = isoyearweek, y = n))
q <- q + geom_col(fill = splstyle::base_color, width = 0.8)
q <- q + lemon::facet_rep_wrap(~location_name, repeat.tick.labels = "y", ncol=4)
q <- q + scale_fill_fhi("Location",palette="primary")
q <- q + scale_x_discrete("Isoweek")
q <- q + scale_y_continuous("Number of reported cases",
  breaks = splstyle::pretty_breaks(5),
  expand = expansion(mult = c(0, 0.1))
)
q <- q + labs(title = "Epicurve from 2018-01-01 to 2018-02-20")
q <- q + labs(caption = fhi_caption())
q <- q + theme_fhi_lines_horizontal()
q <- q + splstyle::set_x_axis_vertical()
q
```

Daily line graph for all geographical areas with vertical x-axis labels

```{r}

d_line <- copy(w)
d_line[, n := stats::rnorm(.N, 500)]

d_line <- d_line[location_code %in% c(
  "county03",
  "county11",
  "county15",
  "county30",
  "county34")]

q <- ggplot(d_line, aes(x = isoyearweek, y = n, group = location_code))
q <- q + geom_line(lwd = 1)
q <- q + splstyle::theme_fhi_lines_horizontal()
q <- q + splstyle::scale_color_fhi(NULL, palette = "primary")
q <- q + splstyle::set_x_axis_vertical()
q <- q + scale_x_discrete("Isoweek")
# q <- q + expand_limits(y = 0)
q <- q + scale_y_continuous("Number of reported cases",
  breaks = splstyle::pretty_breaks(5),
  expand = expansion(mult = c(0, 0.1))
  )
q <- q + labs(title = "Line graph from 2018-01-01 to 2018-02-20")
q <- q + labs(caption = fhi_caption())

# q <- q + lemon::facet_rep_wrap(~location_name, repeat.tick.labels = "y")

q
```

## Coloured epicurves

Sometimes you would like to add colours to differentiate between different variables. This can be done through the `fill` attribute.

```{r}
q <- ggplot(w[location_code %in% c(
  "county03",
  "county11",
  "county15",
  "county30",
  "county34")], 
  aes(x = isoyearweek, y = n, fill = location_name))
q <- q + geom_col(width = 0.8)
q <- q + splstyle::scale_fill_fhi("Location",palette="primary")
q <- q + scale_x_discrete("Isoweek")
q <- q + scale_y_continuous("Number of reported cases",
  breaks = splstyle::pretty_breaks(5),
  expand = expansion(mult = c(0, 0.1))
)
q <- q + labs(title = "Epicurve from 2018-01-01 to 2018-02-20")
q <- q + labs(caption = fhi_caption())
q <- q + splstyle::theme_fhi_lines_horizontal()
q <- q + splstyle::set_x_axis_vertical()
q
```

## Right axis on epicurve

Sometimes you would like to add colours to differentiate between different variables. This can be done through the `fill` attribute.

```{r}
pd <- w[location_code %in% "county03"]
pd[, cum_n := cumsum(n)]

pd[, value_left := n]
pd[, value_right := cum_n]

max_left <- max(pd$value_left)
max_right <- max(pd$value_right)

# increase the space in the y-axis
max_left <- max(c(max_left, 5))
max_right <- max(c(max_right, 5))

pd[, scaled_value_right := value_right / max_right * max_left]

q <- ggplot(pd, aes(x = isoyearweek))
q <- q + geom_col(
  mapping = aes(
    y = value_left,
    fill = "The fill variable",
  ),
  width = 0.8
  )
q <- q + geom_line(
  mapping = aes(
    y = scaled_value_right,
    group = 1,
    color = "The color variable"
  ),
  lwd = 2
  )
q <- q + scale_x_discrete("Isoweek")
q <- q + scale_y_continuous("Number of reported cases",
  breaks = splstyle::pretty_breaks(5),
  expand = expansion(mult = c(0, 0.1)),
  sec.axis = sec_axis(
    name = "Cumulative number of reported cases\n",
    ~ . * max_right / max_left,
    breaks = splstyle::pretty_breaks(5),
    labels = splstyle::format_nor
  )
)
q <- q + splstyle::scale_fill_fhi("Fill", palette = "primary")
q <- q + splstyle::scale_color_fhi("Color", palette = "posneg")
q <- q + labs(title = "Epicurve from 2018-01-01 to 2018-02-20")
q <- q + labs(caption = fhi_caption())
q <- q + splstyle::theme_fhi_lines_horizontal()
q <- q + splstyle::set_x_axis_vertical()
q
```
