---
title: "Flextable"
author: "Celine Victoria Berg-Hansen"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    fig_width: 6
    fig_height: 6
vignette: >
  %\VignetteIndexEntry{Flextable}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Checklist

- Use `ft <- flextable::autofit(ft)`
- If one or more of the columns are too cramped, use `flextable::width()` to adjust the width.
- Use `ft <- flextable::font(ft, fontname = "calibri", part = "all")`
- If the last row in the table is the total of the other rows, use `ft <- flextable::border(ft, i = nrow(tab), border.top = officer::fp_border(width = 1))` 
- Use `ft <- flextable::align_text_col(ft, align = "right")`
- Use `ft <- flextable::align(ft, j = 1, align = "left", part = "all")`


```{r}
library(flextable)
library(data.table)
library(splstyle)
```

## Test data

```{r}
set.seed(4)
dates <- sample(seq.Date(as.Date("2022-01-01"), 
                         as.Date("2022-01-05"), 1),
                200, 
                replace = T)
d <- expand.grid(
  location_code=unique(fhidata::norway_locations_b2020$county_code),
  date = dates
)
# convert to data.table
setDT(d)

# aggregate
d <- d[,
  .(
    n = .N
  ),
  keyby = .(
    location_code,
    date
  )
]

print(d)

# create skeleton with all the dates
skeleton <- data.table(expand.grid(
  location_code = unique(fhidata::norway_locations_b2020$county_code),
  date = seq.Date(min(d$date), max(d$date), 1)
))

# merge the two datasets together
d <- merge(d, skeleton, by=c("location_code", "date"), all=T)

# Fill in 'missing' Ns with 0
d[is.na(n), n := 0]

# change the data.table to be wide instead of long
d <- dcast.data.table(d, location_code ~ date, value.var = "n")

# make a last row with the sum of all the other rows per column
lastrow <- t(apply(d[, -1], 2, sum))
lastrow <- data.table(location_code = "Totalt", lastrow)

# change from location_code to location_name
d[, location_code := splstyle::location_code_to_character(location_code)]

# combine the two datasets together
d <- rbind(d, lastrow)

setnames(d, "location_code", "Fylke")

# print
print(d)
```

## Table

```{r}
tab <- d

ft <- flextable::flextable(tab)
ft <- flextable::autofit(ft)
ft <- flextable::width(ft, width = 0.7)
ft <- flextable::width(ft, j = 1, width = 1.5)
ft <- flextable::width(ft, j = 2:6, width = 1)

ft <- flextable::fontsize(ft, size = 10, part = "all")
ft <- flextable::font(ft, fontname = "calibri", part = "all")
ft <- flextable::border(ft, i = nrow(tab), border.top = officer::fp_border(width = 1))
ft <- flextable::align_text_col(ft, align = "right")
ft <- flextable::align(ft, j = 1, align = "left", part = "all")

ft
```

